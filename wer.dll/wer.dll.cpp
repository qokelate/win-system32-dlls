#include <windows.h>
#include <shlwapi.h>

extern "C" {
extern void *ptr_WerAddExcludedApplication;
void *ptr_WerAddExcludedApplication = NULL;
extern void *ptr_WerRemoveExcludedApplication;
void *ptr_WerRemoveExcludedApplication = NULL;
extern void *ptr_WerReportAddDump;
void *ptr_WerReportAddDump = NULL;
extern void *ptr_WerReportAddFile;
void *ptr_WerReportAddFile = NULL;
extern void *ptr_WerReportCloseHandle;
void *ptr_WerReportCloseHandle = NULL;
extern void *ptr_WerReportCreate;
void *ptr_WerReportCreate = NULL;
extern void *ptr_WerReportSetParameter;
void *ptr_WerReportSetParameter = NULL;
extern void *ptr_WerReportSetUIOption;
void *ptr_WerReportSetUIOption = NULL;
extern void *ptr_WerReportSubmit;
void *ptr_WerReportSubmit = NULL;
extern void *ptr_WerSysprepCleanup;
void *ptr_WerSysprepCleanup = NULL;
extern void *ptr_WerSysprepGeneralize;
void *ptr_WerSysprepGeneralize = NULL;
extern void *ptr_WerSysprepSpecialize;
void *ptr_WerSysprepSpecialize = NULL;
extern void *ptr_WerUnattendedSetup;
void *ptr_WerUnattendedSetup = NULL;
extern void *ptr_WerpAddAppCompatData;
void *ptr_WerpAddAppCompatData = NULL;
extern void *ptr_WerpAddFile;
void *ptr_WerpAddFile = NULL;
extern void *ptr_WerpAddMemoryBlock;
void *ptr_WerpAddMemoryBlock = NULL;
extern void *ptr_WerpAddRegisteredDataToReport;
void *ptr_WerpAddRegisteredDataToReport = NULL;
extern void *ptr_WerpAddSecondaryParameter;
void *ptr_WerpAddSecondaryParameter = NULL;
extern void *ptr_WerpAddTextToReport;
void *ptr_WerpAddTextToReport = NULL;
extern void *ptr_WerpArchiveReport;
void *ptr_WerpArchiveReport = NULL;
extern void *ptr_WerpCancelResponseDownload;
void *ptr_WerpCancelResponseDownload = NULL;
extern void *ptr_WerpCancelUpload;
void *ptr_WerpCancelUpload = NULL;
extern void *ptr_WerpCloseStore;
void *ptr_WerpCloseStore = NULL;
extern void *ptr_WerpCreateIntegratorReportId;
void *ptr_WerpCreateIntegratorReportId = NULL;
extern void *ptr_WerpCreateMachineStore;
void *ptr_WerpCreateMachineStore = NULL;
extern void *ptr_WerpDeleteReport;
void *ptr_WerpDeleteReport = NULL;
extern void *ptr_WerpDestroyWerString;
void *ptr_WerpDestroyWerString = NULL;
extern void *ptr_WerpDownloadResponse;
void *ptr_WerpDownloadResponse = NULL;
extern void *ptr_WerpDownloadResponseTemplate;
void *ptr_WerpDownloadResponseTemplate = NULL;
extern void *ptr_WerpEnumerateStoreNext;
void *ptr_WerpEnumerateStoreNext = NULL;
extern void *ptr_WerpEnumerateStoreStart;
void *ptr_WerpEnumerateStoreStart = NULL;
extern void *ptr_WerpExtractReportFiles;
void *ptr_WerpExtractReportFiles = NULL;
extern void *ptr_WerpFreeString;
void *ptr_WerpFreeString = NULL;
extern void *ptr_WerpGetBucketId;
void *ptr_WerpGetBucketId = NULL;
extern void *ptr_WerpGetBucketString;
void *ptr_WerpGetBucketString = NULL;
extern void *ptr_WerpGetDynamicParameter;
void *ptr_WerpGetDynamicParameter = NULL;
extern void *ptr_WerpGetEventType;
void *ptr_WerpGetEventType = NULL;
extern void *ptr_WerpGetFileByIndex;
void *ptr_WerpGetFileByIndex = NULL;
extern void *ptr_WerpGetFilePathByIndex;
void *ptr_WerpGetFilePathByIndex = NULL;
extern void *ptr_WerpGetIntegratorReportId;
void *ptr_WerpGetIntegratorReportId = NULL;
extern void *ptr_WerpGetLoadedModuleByIndex;
void *ptr_WerpGetLoadedModuleByIndex = NULL;
extern void *ptr_WerpGetNumFiles;
void *ptr_WerpGetNumFiles = NULL;
extern void *ptr_WerpGetNumLoadedModules;
void *ptr_WerpGetNumLoadedModules = NULL;
extern void *ptr_WerpGetNumSecParams;
void *ptr_WerpGetNumSecParams = NULL;
extern void *ptr_WerpGetNumSigParams;
void *ptr_WerpGetNumSigParams = NULL;
extern void *ptr_WerpGetReportConsent;
void *ptr_WerpGetReportConsent = NULL;
extern void *ptr_WerpGetReportFinalConsent;
void *ptr_WerpGetReportFinalConsent = NULL;
extern void *ptr_WerpGetReportFlags;
void *ptr_WerpGetReportFlags = NULL;
extern void *ptr_WerpGetReportInformation;
void *ptr_WerpGetReportInformation = NULL;
extern void *ptr_WerpGetReportSettings;
void *ptr_WerpGetReportSettings = NULL;
extern void *ptr_WerpGetReportTime;
void *ptr_WerpGetReportTime = NULL;
extern void *ptr_WerpGetReportType;
void *ptr_WerpGetReportType = NULL;
extern void *ptr_WerpGetResponseId;
void *ptr_WerpGetResponseId = NULL;
extern void *ptr_WerpGetResponseUrl;
void *ptr_WerpGetResponseUrl = NULL;
extern void *ptr_WerpGetSecParamByIndex;
void *ptr_WerpGetSecParamByIndex = NULL;
extern void *ptr_WerpGetSigParamByIndex;
void *ptr_WerpGetSigParamByIndex = NULL;
extern void *ptr_WerpGetStoreLocation;
void *ptr_WerpGetStoreLocation = NULL;
extern void *ptr_WerpGetStorePath;
void *ptr_WerpGetStorePath = NULL;
extern void *ptr_WerpGetStoreType;
void *ptr_WerpGetStoreType = NULL;
extern void *ptr_WerpGetTextFromReport;
void *ptr_WerpGetTextFromReport = NULL;
extern void *ptr_WerpGetUIParamByIndex;
void *ptr_WerpGetUIParamByIndex = NULL;
extern void *ptr_WerpGetUploadTime;
void *ptr_WerpGetUploadTime = NULL;
extern void *ptr_WerpGetWerStringData;
void *ptr_WerpGetWerStringData = NULL;
extern void *ptr_WerpGetWow64Process;
void *ptr_WerpGetWow64Process = NULL;
extern void *ptr_WerpIsDisabled;
void *ptr_WerpIsDisabled = NULL;
extern void *ptr_WerpIsTransportAvailable;
void *ptr_WerpIsTransportAvailable = NULL;
extern void *ptr_WerpLaunchResponse;
void *ptr_WerpLaunchResponse = NULL;
extern void *ptr_WerpLoadReport;
void *ptr_WerpLoadReport = NULL;
extern void *ptr_WerpOpenMachineArchive;
void *ptr_WerpOpenMachineArchive = NULL;
extern void *ptr_WerpOpenMachineQueue;
void *ptr_WerpOpenMachineQueue = NULL;
extern void *ptr_WerpOpenUserArchive;
void *ptr_WerpOpenUserArchive = NULL;
extern void *ptr_WerpOpenUserQueue;
void *ptr_WerpOpenUserQueue = NULL;
extern void *ptr_WerpPromtUser;
void *ptr_WerpPromtUser = NULL;
extern void *ptr_WerpReportCancel;
void *ptr_WerpReportCancel = NULL;
extern void *ptr_WerpRestartApplication;
void *ptr_WerpRestartApplication = NULL;
extern void *ptr_WerpSetCallBack;
void *ptr_WerpSetCallBack = NULL;
extern void *ptr_WerpSetDefaultUserConsent;
void *ptr_WerpSetDefaultUserConsent = NULL;
extern void *ptr_WerpSetDynamicParameter;
void *ptr_WerpSetDynamicParameter = NULL;
extern void *ptr_WerpSetEventName;
void *ptr_WerpSetEventName = NULL;
extern void *ptr_WerpSetIntegratorReportId;
void *ptr_WerpSetIntegratorReportId = NULL;
extern void *ptr_WerpSetReportFlags;
void *ptr_WerpSetReportFlags = NULL;
extern void *ptr_WerpSetReportInformation;
void *ptr_WerpSetReportInformation = NULL;
extern void *ptr_WerpSetReportTime;
void *ptr_WerpSetReportTime = NULL;
extern void *ptr_WerpSetReportUploadContextToken;
void *ptr_WerpSetReportUploadContextToken = NULL;
extern void *ptr_WerpShowUpsellUI;
void *ptr_WerpShowUpsellUI = NULL;
extern void *ptr_WerpSubmitReportFromStore;
void *ptr_WerpSubmitReportFromStore = NULL;
extern void *ptr_WerpSvcReportFromMachineQueue;
void *ptr_WerpSvcReportFromMachineQueue = NULL;
extern void *ptr_WerpUpdateReportResponse;
void *ptr_WerpUpdateReportResponse = NULL;
}


static HMODULE hModule = NULL;
static void module_init()
{    
   if (hModule) return;
   wchar_t sz_module_file[MAX_PATH];
   GetSystemDirectoryW(sz_module_file, MAX_PATH);
   wcscat_s(sz_module_file, L"\\wer.dll");
   hModule = LoadLibraryW(sz_module_file);
   if (!hModule) return;

   #define __vartype(x) decltype(x)
   ptr_WerAddExcludedApplication = (__vartype(ptr_WerAddExcludedApplication))GetProcAddress(hModule, "WerAddExcludedApplication");
   ptr_WerRemoveExcludedApplication = (__vartype(ptr_WerRemoveExcludedApplication))GetProcAddress(hModule, "WerRemoveExcludedApplication");
   ptr_WerReportAddDump = (__vartype(ptr_WerReportAddDump))GetProcAddress(hModule, "WerReportAddDump");
   ptr_WerReportAddFile = (__vartype(ptr_WerReportAddFile))GetProcAddress(hModule, "WerReportAddFile");
   ptr_WerReportCloseHandle = (__vartype(ptr_WerReportCloseHandle))GetProcAddress(hModule, "WerReportCloseHandle");
   ptr_WerReportCreate = (__vartype(ptr_WerReportCreate))GetProcAddress(hModule, "WerReportCreate");
   ptr_WerReportSetParameter = (__vartype(ptr_WerReportSetParameter))GetProcAddress(hModule, "WerReportSetParameter");
   ptr_WerReportSetUIOption = (__vartype(ptr_WerReportSetUIOption))GetProcAddress(hModule, "WerReportSetUIOption");
   ptr_WerReportSubmit = (__vartype(ptr_WerReportSubmit))GetProcAddress(hModule, "WerReportSubmit");
   ptr_WerSysprepCleanup = (__vartype(ptr_WerSysprepCleanup))GetProcAddress(hModule, "WerSysprepCleanup");
   ptr_WerSysprepGeneralize = (__vartype(ptr_WerSysprepGeneralize))GetProcAddress(hModule, "WerSysprepGeneralize");
   ptr_WerSysprepSpecialize = (__vartype(ptr_WerSysprepSpecialize))GetProcAddress(hModule, "WerSysprepSpecialize");
   ptr_WerUnattendedSetup = (__vartype(ptr_WerUnattendedSetup))GetProcAddress(hModule, "WerUnattendedSetup");
   ptr_WerpAddAppCompatData = (__vartype(ptr_WerpAddAppCompatData))GetProcAddress(hModule, "WerpAddAppCompatData");
   ptr_WerpAddFile = (__vartype(ptr_WerpAddFile))GetProcAddress(hModule, "WerpAddFile");
   ptr_WerpAddMemoryBlock = (__vartype(ptr_WerpAddMemoryBlock))GetProcAddress(hModule, "WerpAddMemoryBlock");
   ptr_WerpAddRegisteredDataToReport = (__vartype(ptr_WerpAddRegisteredDataToReport))GetProcAddress(hModule, "WerpAddRegisteredDataToReport");
   ptr_WerpAddSecondaryParameter = (__vartype(ptr_WerpAddSecondaryParameter))GetProcAddress(hModule, "WerpAddSecondaryParameter");
   ptr_WerpAddTextToReport = (__vartype(ptr_WerpAddTextToReport))GetProcAddress(hModule, "WerpAddTextToReport");
   ptr_WerpArchiveReport = (__vartype(ptr_WerpArchiveReport))GetProcAddress(hModule, "WerpArchiveReport");
   ptr_WerpCancelResponseDownload = (__vartype(ptr_WerpCancelResponseDownload))GetProcAddress(hModule, "WerpCancelResponseDownload");
   ptr_WerpCancelUpload = (__vartype(ptr_WerpCancelUpload))GetProcAddress(hModule, "WerpCancelUpload");
   ptr_WerpCloseStore = (__vartype(ptr_WerpCloseStore))GetProcAddress(hModule, "WerpCloseStore");
   ptr_WerpCreateIntegratorReportId = (__vartype(ptr_WerpCreateIntegratorReportId))GetProcAddress(hModule, "WerpCreateIntegratorReportId");
   ptr_WerpCreateMachineStore = (__vartype(ptr_WerpCreateMachineStore))GetProcAddress(hModule, "WerpCreateMachineStore");
   ptr_WerpDeleteReport = (__vartype(ptr_WerpDeleteReport))GetProcAddress(hModule, "WerpDeleteReport");
   ptr_WerpDestroyWerString = (__vartype(ptr_WerpDestroyWerString))GetProcAddress(hModule, "WerpDestroyWerString");
   ptr_WerpDownloadResponse = (__vartype(ptr_WerpDownloadResponse))GetProcAddress(hModule, "WerpDownloadResponse");
   ptr_WerpDownloadResponseTemplate = (__vartype(ptr_WerpDownloadResponseTemplate))GetProcAddress(hModule, "WerpDownloadResponseTemplate");
   ptr_WerpEnumerateStoreNext = (__vartype(ptr_WerpEnumerateStoreNext))GetProcAddress(hModule, "WerpEnumerateStoreNext");
   ptr_WerpEnumerateStoreStart = (__vartype(ptr_WerpEnumerateStoreStart))GetProcAddress(hModule, "WerpEnumerateStoreStart");
   ptr_WerpExtractReportFiles = (__vartype(ptr_WerpExtractReportFiles))GetProcAddress(hModule, "WerpExtractReportFiles");
   ptr_WerpFreeString = (__vartype(ptr_WerpFreeString))GetProcAddress(hModule, "WerpFreeString");
   ptr_WerpGetBucketId = (__vartype(ptr_WerpGetBucketId))GetProcAddress(hModule, "WerpGetBucketId");
   ptr_WerpGetBucketString = (__vartype(ptr_WerpGetBucketString))GetProcAddress(hModule, "WerpGetBucketString");
   ptr_WerpGetDynamicParameter = (__vartype(ptr_WerpGetDynamicParameter))GetProcAddress(hModule, "WerpGetDynamicParameter");
   ptr_WerpGetEventType = (__vartype(ptr_WerpGetEventType))GetProcAddress(hModule, "WerpGetEventType");
   ptr_WerpGetFileByIndex = (__vartype(ptr_WerpGetFileByIndex))GetProcAddress(hModule, "WerpGetFileByIndex");
   ptr_WerpGetFilePathByIndex = (__vartype(ptr_WerpGetFilePathByIndex))GetProcAddress(hModule, "WerpGetFilePathByIndex");
   ptr_WerpGetIntegratorReportId = (__vartype(ptr_WerpGetIntegratorReportId))GetProcAddress(hModule, "WerpGetIntegratorReportId");
   ptr_WerpGetLoadedModuleByIndex = (__vartype(ptr_WerpGetLoadedModuleByIndex))GetProcAddress(hModule, "WerpGetLoadedModuleByIndex");
   ptr_WerpGetNumFiles = (__vartype(ptr_WerpGetNumFiles))GetProcAddress(hModule, "WerpGetNumFiles");
   ptr_WerpGetNumLoadedModules = (__vartype(ptr_WerpGetNumLoadedModules))GetProcAddress(hModule, "WerpGetNumLoadedModules");
   ptr_WerpGetNumSecParams = (__vartype(ptr_WerpGetNumSecParams))GetProcAddress(hModule, "WerpGetNumSecParams");
   ptr_WerpGetNumSigParams = (__vartype(ptr_WerpGetNumSigParams))GetProcAddress(hModule, "WerpGetNumSigParams");
   ptr_WerpGetReportConsent = (__vartype(ptr_WerpGetReportConsent))GetProcAddress(hModule, "WerpGetReportConsent");
   ptr_WerpGetReportFinalConsent = (__vartype(ptr_WerpGetReportFinalConsent))GetProcAddress(hModule, "WerpGetReportFinalConsent");
   ptr_WerpGetReportFlags = (__vartype(ptr_WerpGetReportFlags))GetProcAddress(hModule, "WerpGetReportFlags");
   ptr_WerpGetReportInformation = (__vartype(ptr_WerpGetReportInformation))GetProcAddress(hModule, "WerpGetReportInformation");
   ptr_WerpGetReportSettings = (__vartype(ptr_WerpGetReportSettings))GetProcAddress(hModule, "WerpGetReportSettings");
   ptr_WerpGetReportTime = (__vartype(ptr_WerpGetReportTime))GetProcAddress(hModule, "WerpGetReportTime");
   ptr_WerpGetReportType = (__vartype(ptr_WerpGetReportType))GetProcAddress(hModule, "WerpGetReportType");
   ptr_WerpGetResponseId = (__vartype(ptr_WerpGetResponseId))GetProcAddress(hModule, "WerpGetResponseId");
   ptr_WerpGetResponseUrl = (__vartype(ptr_WerpGetResponseUrl))GetProcAddress(hModule, "WerpGetResponseUrl");
   ptr_WerpGetSecParamByIndex = (__vartype(ptr_WerpGetSecParamByIndex))GetProcAddress(hModule, "WerpGetSecParamByIndex");
   ptr_WerpGetSigParamByIndex = (__vartype(ptr_WerpGetSigParamByIndex))GetProcAddress(hModule, "WerpGetSigParamByIndex");
   ptr_WerpGetStoreLocation = (__vartype(ptr_WerpGetStoreLocation))GetProcAddress(hModule, "WerpGetStoreLocation");
   ptr_WerpGetStorePath = (__vartype(ptr_WerpGetStorePath))GetProcAddress(hModule, "WerpGetStorePath");
   ptr_WerpGetStoreType = (__vartype(ptr_WerpGetStoreType))GetProcAddress(hModule, "WerpGetStoreType");
   ptr_WerpGetTextFromReport = (__vartype(ptr_WerpGetTextFromReport))GetProcAddress(hModule, "WerpGetTextFromReport");
   ptr_WerpGetUIParamByIndex = (__vartype(ptr_WerpGetUIParamByIndex))GetProcAddress(hModule, "WerpGetUIParamByIndex");
   ptr_WerpGetUploadTime = (__vartype(ptr_WerpGetUploadTime))GetProcAddress(hModule, "WerpGetUploadTime");
   ptr_WerpGetWerStringData = (__vartype(ptr_WerpGetWerStringData))GetProcAddress(hModule, "WerpGetWerStringData");
   ptr_WerpGetWow64Process = (__vartype(ptr_WerpGetWow64Process))GetProcAddress(hModule, "WerpGetWow64Process");
   ptr_WerpIsDisabled = (__vartype(ptr_WerpIsDisabled))GetProcAddress(hModule, "WerpIsDisabled");
   ptr_WerpIsTransportAvailable = (__vartype(ptr_WerpIsTransportAvailable))GetProcAddress(hModule, "WerpIsTransportAvailable");
   ptr_WerpLaunchResponse = (__vartype(ptr_WerpLaunchResponse))GetProcAddress(hModule, "WerpLaunchResponse");
   ptr_WerpLoadReport = (__vartype(ptr_WerpLoadReport))GetProcAddress(hModule, "WerpLoadReport");
   ptr_WerpOpenMachineArchive = (__vartype(ptr_WerpOpenMachineArchive))GetProcAddress(hModule, "WerpOpenMachineArchive");
   ptr_WerpOpenMachineQueue = (__vartype(ptr_WerpOpenMachineQueue))GetProcAddress(hModule, "WerpOpenMachineQueue");
   ptr_WerpOpenUserArchive = (__vartype(ptr_WerpOpenUserArchive))GetProcAddress(hModule, "WerpOpenUserArchive");
   ptr_WerpOpenUserQueue = (__vartype(ptr_WerpOpenUserQueue))GetProcAddress(hModule, "WerpOpenUserQueue");
   ptr_WerpPromtUser = (__vartype(ptr_WerpPromtUser))GetProcAddress(hModule, "WerpPromtUser");
   ptr_WerpReportCancel = (__vartype(ptr_WerpReportCancel))GetProcAddress(hModule, "WerpReportCancel");
   ptr_WerpRestartApplication = (__vartype(ptr_WerpRestartApplication))GetProcAddress(hModule, "WerpRestartApplication");
   ptr_WerpSetCallBack = (__vartype(ptr_WerpSetCallBack))GetProcAddress(hModule, "WerpSetCallBack");
   ptr_WerpSetDefaultUserConsent = (__vartype(ptr_WerpSetDefaultUserConsent))GetProcAddress(hModule, "WerpSetDefaultUserConsent");
   ptr_WerpSetDynamicParameter = (__vartype(ptr_WerpSetDynamicParameter))GetProcAddress(hModule, "WerpSetDynamicParameter");
   ptr_WerpSetEventName = (__vartype(ptr_WerpSetEventName))GetProcAddress(hModule, "WerpSetEventName");
   ptr_WerpSetIntegratorReportId = (__vartype(ptr_WerpSetIntegratorReportId))GetProcAddress(hModule, "WerpSetIntegratorReportId");
   ptr_WerpSetReportFlags = (__vartype(ptr_WerpSetReportFlags))GetProcAddress(hModule, "WerpSetReportFlags");
   ptr_WerpSetReportInformation = (__vartype(ptr_WerpSetReportInformation))GetProcAddress(hModule, "WerpSetReportInformation");
   ptr_WerpSetReportTime = (__vartype(ptr_WerpSetReportTime))GetProcAddress(hModule, "WerpSetReportTime");
   ptr_WerpSetReportUploadContextToken = (__vartype(ptr_WerpSetReportUploadContextToken))GetProcAddress(hModule, "WerpSetReportUploadContextToken");
   ptr_WerpShowUpsellUI = (__vartype(ptr_WerpShowUpsellUI))GetProcAddress(hModule, "WerpShowUpsellUI");
   ptr_WerpSubmitReportFromStore = (__vartype(ptr_WerpSubmitReportFromStore))GetProcAddress(hModule, "WerpSubmitReportFromStore");
   ptr_WerpSvcReportFromMachineQueue = (__vartype(ptr_WerpSvcReportFromMachineQueue))GetProcAddress(hModule, "WerpSvcReportFromMachineQueue");
   ptr_WerpUpdateReportResponse = (__vartype(ptr_WerpUpdateReportResponse))GetProcAddress(hModule, "WerpUpdateReportResponse");
   #undef __vartype
}

extern "C" BOOL __stdcall DllMain( HMODULE hModule,	DWORD ul_reason_for_call,LPVOID lpReserved)
{
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH:
    {
        module_init();
        wchar_t tmp1[2048];
        GetModuleFileNameW(NULL, tmp1, _countof(tmp1));
        PathRemoveExtensionW(tmp1);
        wcscat(tmp1, L".hook.dll");
        LoadLibraryW(tmp1);
        break;
    }
	case DLL_PROCESS_DETACH:
		break;
	}
	return TRUE;
}

