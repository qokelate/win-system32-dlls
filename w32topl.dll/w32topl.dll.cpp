#include <windows.h>
#include <shlwapi.h>

extern "C" {
extern void *ptr_ToplAddEdgeSetToGraph;
void *ptr_ToplAddEdgeSetToGraph = NULL;
extern void *ptr_ToplAddEdgeToGraph;
void *ptr_ToplAddEdgeToGraph = NULL;
extern void *ptr_ToplDeleteComponents;
void *ptr_ToplDeleteComponents = NULL;
extern void *ptr_ToplDeleteGraphState;
void *ptr_ToplDeleteGraphState = NULL;
extern void *ptr_ToplDeleteSpanningTreeEdges;
void *ptr_ToplDeleteSpanningTreeEdges = NULL;
extern void *ptr_ToplEdgeAssociate;
void *ptr_ToplEdgeAssociate = NULL;
extern void *ptr_ToplEdgeCreate;
void *ptr_ToplEdgeCreate = NULL;
extern void *ptr_ToplEdgeDestroy;
void *ptr_ToplEdgeDestroy = NULL;
extern void *ptr_ToplEdgeDisassociate;
void *ptr_ToplEdgeDisassociate = NULL;
extern void *ptr_ToplEdgeFree;
void *ptr_ToplEdgeFree = NULL;
extern void *ptr_ToplEdgeGetFromVertex;
void *ptr_ToplEdgeGetFromVertex = NULL;
extern void *ptr_ToplEdgeGetToVertex;
void *ptr_ToplEdgeGetToVertex = NULL;
extern void *ptr_ToplEdgeGetWeight;
void *ptr_ToplEdgeGetWeight = NULL;
extern void *ptr_ToplEdgeInit;
void *ptr_ToplEdgeInit = NULL;
extern void *ptr_ToplEdgeSetFromVertex;
void *ptr_ToplEdgeSetFromVertex = NULL;
extern void *ptr_ToplEdgeSetToVertex;
void *ptr_ToplEdgeSetToVertex = NULL;
extern void *ptr_ToplEdgeSetVtx;
void *ptr_ToplEdgeSetVtx = NULL;
extern void *ptr_ToplEdgeSetWeight;
void *ptr_ToplEdgeSetWeight = NULL;
extern void *ptr_ToplFree;
void *ptr_ToplFree = NULL;
extern void *ptr_ToplGetAlwaysSchedule;
void *ptr_ToplGetAlwaysSchedule = NULL;
extern void *ptr_ToplGetSpanningTreeEdgesForVtx;
void *ptr_ToplGetSpanningTreeEdgesForVtx = NULL;
extern void *ptr_ToplGraphAddVertex;
void *ptr_ToplGraphAddVertex = NULL;
extern void *ptr_ToplGraphCreate;
void *ptr_ToplGraphCreate = NULL;
extern void *ptr_ToplGraphDestroy;
void *ptr_ToplGraphDestroy = NULL;
extern void *ptr_ToplGraphFindEdgesForMST;
void *ptr_ToplGraphFindEdgesForMST = NULL;
extern void *ptr_ToplGraphFree;
void *ptr_ToplGraphFree = NULL;
extern void *ptr_ToplGraphInit;
void *ptr_ToplGraphInit = NULL;
extern void *ptr_ToplGraphMakeRing;
void *ptr_ToplGraphMakeRing = NULL;
extern void *ptr_ToplGraphNumberOfVertices;
void *ptr_ToplGraphNumberOfVertices = NULL;
extern void *ptr_ToplGraphRemoveVertex;
void *ptr_ToplGraphRemoveVertex = NULL;
extern void *ptr_ToplGraphSetVertexIter;
void *ptr_ToplGraphSetVertexIter = NULL;
extern void *ptr_ToplHeapCreate;
void *ptr_ToplHeapCreate = NULL;
extern void *ptr_ToplHeapDestroy;
void *ptr_ToplHeapDestroy = NULL;
extern void *ptr_ToplHeapExtractMin;
void *ptr_ToplHeapExtractMin = NULL;
extern void *ptr_ToplHeapInsert;
void *ptr_ToplHeapInsert = NULL;
extern void *ptr_ToplHeapIsElementOf;
void *ptr_ToplHeapIsElementOf = NULL;
extern void *ptr_ToplHeapIsEmpty;
void *ptr_ToplHeapIsEmpty = NULL;
extern void *ptr_ToplIsToplException;
void *ptr_ToplIsToplException = NULL;
extern void *ptr_ToplIterAdvance;
void *ptr_ToplIterAdvance = NULL;
extern void *ptr_ToplIterCreate;
void *ptr_ToplIterCreate = NULL;
extern void *ptr_ToplIterFree;
void *ptr_ToplIterFree = NULL;
extern void *ptr_ToplIterGetObject;
void *ptr_ToplIterGetObject = NULL;
extern void *ptr_ToplListAddElem;
void *ptr_ToplListAddElem = NULL;
extern void *ptr_ToplListCreate;
void *ptr_ToplListCreate = NULL;
extern void *ptr_ToplListFree;
void *ptr_ToplListFree = NULL;
extern void *ptr_ToplListNumberOfElements;
void *ptr_ToplListNumberOfElements = NULL;
extern void *ptr_ToplListRemoveElem;
void *ptr_ToplListRemoveElem = NULL;
extern void *ptr_ToplListSetIter;
void *ptr_ToplListSetIter = NULL;
extern void *ptr_ToplMakeGraphState;
void *ptr_ToplMakeGraphState = NULL;
extern void *ptr_ToplPScheduleValid;
void *ptr_ToplPScheduleValid = NULL;
extern void *ptr_ToplSTHeapAdd;
void *ptr_ToplSTHeapAdd = NULL;
extern void *ptr_ToplSTHeapCostReduced;
void *ptr_ToplSTHeapCostReduced = NULL;
extern void *ptr_ToplSTHeapDestroy;
void *ptr_ToplSTHeapDestroy = NULL;
extern void *ptr_ToplSTHeapExtractMin;
void *ptr_ToplSTHeapExtractMin = NULL;
extern void *ptr_ToplSTHeapInit;
void *ptr_ToplSTHeapInit = NULL;
extern void *ptr_ToplScheduleCacheCreate;
void *ptr_ToplScheduleCacheCreate = NULL;
extern void *ptr_ToplScheduleCacheDestroy;
void *ptr_ToplScheduleCacheDestroy = NULL;
extern void *ptr_ToplScheduleCreate;
void *ptr_ToplScheduleCreate = NULL;
extern void *ptr_ToplScheduleDuration;
void *ptr_ToplScheduleDuration = NULL;
extern void *ptr_ToplScheduleExportReadonly;
void *ptr_ToplScheduleExportReadonly = NULL;
extern void *ptr_ToplScheduleImport;
void *ptr_ToplScheduleImport = NULL;
extern void *ptr_ToplScheduleIsEqual;
void *ptr_ToplScheduleIsEqual = NULL;
extern void *ptr_ToplScheduleMaxUnavailable;
void *ptr_ToplScheduleMaxUnavailable = NULL;
extern void *ptr_ToplScheduleMerge;
void *ptr_ToplScheduleMerge = NULL;
extern void *ptr_ToplScheduleNumEntries;
void *ptr_ToplScheduleNumEntries = NULL;
extern void *ptr_ToplScheduleValid;
void *ptr_ToplScheduleValid = NULL;
extern void *ptr_ToplSetAllocator;
void *ptr_ToplSetAllocator = NULL;
extern void *ptr_ToplVertexCreate;
void *ptr_ToplVertexCreate = NULL;
extern void *ptr_ToplVertexDestroy;
void *ptr_ToplVertexDestroy = NULL;
extern void *ptr_ToplVertexFree;
void *ptr_ToplVertexFree = NULL;
extern void *ptr_ToplVertexGetId;
void *ptr_ToplVertexGetId = NULL;
extern void *ptr_ToplVertexGetInEdge;
void *ptr_ToplVertexGetInEdge = NULL;
extern void *ptr_ToplVertexGetOutEdge;
void *ptr_ToplVertexGetOutEdge = NULL;
extern void *ptr_ToplVertexGetParent;
void *ptr_ToplVertexGetParent = NULL;
extern void *ptr_ToplVertexInit;
void *ptr_ToplVertexInit = NULL;
extern void *ptr_ToplVertexNumberOfInEdges;
void *ptr_ToplVertexNumberOfInEdges = NULL;
extern void *ptr_ToplVertexNumberOfOutEdges;
void *ptr_ToplVertexNumberOfOutEdges = NULL;
extern void *ptr_ToplVertexSetId;
void *ptr_ToplVertexSetId = NULL;
extern void *ptr_ToplVertexSetParent;
void *ptr_ToplVertexSetParent = NULL;
}


static HMODULE hModule = NULL;
static void module_init()
{    
   if (hModule) return;
   wchar_t sz_module_file[MAX_PATH];
   GetSystemDirectoryW(sz_module_file, MAX_PATH);
   wcscat_s(sz_module_file, L"\\w32topl.dll");
   hModule = LoadLibraryW(sz_module_file);
   if (!hModule) return;

   #define __vartype(x) decltype(x)
   ptr_ToplAddEdgeSetToGraph = (__vartype(ptr_ToplAddEdgeSetToGraph))GetProcAddress(hModule, "ToplAddEdgeSetToGraph");
   ptr_ToplAddEdgeToGraph = (__vartype(ptr_ToplAddEdgeToGraph))GetProcAddress(hModule, "ToplAddEdgeToGraph");
   ptr_ToplDeleteComponents = (__vartype(ptr_ToplDeleteComponents))GetProcAddress(hModule, "ToplDeleteComponents");
   ptr_ToplDeleteGraphState = (__vartype(ptr_ToplDeleteGraphState))GetProcAddress(hModule, "ToplDeleteGraphState");
   ptr_ToplDeleteSpanningTreeEdges = (__vartype(ptr_ToplDeleteSpanningTreeEdges))GetProcAddress(hModule, "ToplDeleteSpanningTreeEdges");
   ptr_ToplEdgeAssociate = (__vartype(ptr_ToplEdgeAssociate))GetProcAddress(hModule, "ToplEdgeAssociate");
   ptr_ToplEdgeCreate = (__vartype(ptr_ToplEdgeCreate))GetProcAddress(hModule, "ToplEdgeCreate");
   ptr_ToplEdgeDestroy = (__vartype(ptr_ToplEdgeDestroy))GetProcAddress(hModule, "ToplEdgeDestroy");
   ptr_ToplEdgeDisassociate = (__vartype(ptr_ToplEdgeDisassociate))GetProcAddress(hModule, "ToplEdgeDisassociate");
   ptr_ToplEdgeFree = (__vartype(ptr_ToplEdgeFree))GetProcAddress(hModule, "ToplEdgeFree");
   ptr_ToplEdgeGetFromVertex = (__vartype(ptr_ToplEdgeGetFromVertex))GetProcAddress(hModule, "ToplEdgeGetFromVertex");
   ptr_ToplEdgeGetToVertex = (__vartype(ptr_ToplEdgeGetToVertex))GetProcAddress(hModule, "ToplEdgeGetToVertex");
   ptr_ToplEdgeGetWeight = (__vartype(ptr_ToplEdgeGetWeight))GetProcAddress(hModule, "ToplEdgeGetWeight");
   ptr_ToplEdgeInit = (__vartype(ptr_ToplEdgeInit))GetProcAddress(hModule, "ToplEdgeInit");
   ptr_ToplEdgeSetFromVertex = (__vartype(ptr_ToplEdgeSetFromVertex))GetProcAddress(hModule, "ToplEdgeSetFromVertex");
   ptr_ToplEdgeSetToVertex = (__vartype(ptr_ToplEdgeSetToVertex))GetProcAddress(hModule, "ToplEdgeSetToVertex");
   ptr_ToplEdgeSetVtx = (__vartype(ptr_ToplEdgeSetVtx))GetProcAddress(hModule, "ToplEdgeSetVtx");
   ptr_ToplEdgeSetWeight = (__vartype(ptr_ToplEdgeSetWeight))GetProcAddress(hModule, "ToplEdgeSetWeight");
   ptr_ToplFree = (__vartype(ptr_ToplFree))GetProcAddress(hModule, "ToplFree");
   ptr_ToplGetAlwaysSchedule = (__vartype(ptr_ToplGetAlwaysSchedule))GetProcAddress(hModule, "ToplGetAlwaysSchedule");
   ptr_ToplGetSpanningTreeEdgesForVtx = (__vartype(ptr_ToplGetSpanningTreeEdgesForVtx))GetProcAddress(hModule, "ToplGetSpanningTreeEdgesForVtx");
   ptr_ToplGraphAddVertex = (__vartype(ptr_ToplGraphAddVertex))GetProcAddress(hModule, "ToplGraphAddVertex");
   ptr_ToplGraphCreate = (__vartype(ptr_ToplGraphCreate))GetProcAddress(hModule, "ToplGraphCreate");
   ptr_ToplGraphDestroy = (__vartype(ptr_ToplGraphDestroy))GetProcAddress(hModule, "ToplGraphDestroy");
   ptr_ToplGraphFindEdgesForMST = (__vartype(ptr_ToplGraphFindEdgesForMST))GetProcAddress(hModule, "ToplGraphFindEdgesForMST");
   ptr_ToplGraphFree = (__vartype(ptr_ToplGraphFree))GetProcAddress(hModule, "ToplGraphFree");
   ptr_ToplGraphInit = (__vartype(ptr_ToplGraphInit))GetProcAddress(hModule, "ToplGraphInit");
   ptr_ToplGraphMakeRing = (__vartype(ptr_ToplGraphMakeRing))GetProcAddress(hModule, "ToplGraphMakeRing");
   ptr_ToplGraphNumberOfVertices = (__vartype(ptr_ToplGraphNumberOfVertices))GetProcAddress(hModule, "ToplGraphNumberOfVertices");
   ptr_ToplGraphRemoveVertex = (__vartype(ptr_ToplGraphRemoveVertex))GetProcAddress(hModule, "ToplGraphRemoveVertex");
   ptr_ToplGraphSetVertexIter = (__vartype(ptr_ToplGraphSetVertexIter))GetProcAddress(hModule, "ToplGraphSetVertexIter");
   ptr_ToplHeapCreate = (__vartype(ptr_ToplHeapCreate))GetProcAddress(hModule, "ToplHeapCreate");
   ptr_ToplHeapDestroy = (__vartype(ptr_ToplHeapDestroy))GetProcAddress(hModule, "ToplHeapDestroy");
   ptr_ToplHeapExtractMin = (__vartype(ptr_ToplHeapExtractMin))GetProcAddress(hModule, "ToplHeapExtractMin");
   ptr_ToplHeapInsert = (__vartype(ptr_ToplHeapInsert))GetProcAddress(hModule, "ToplHeapInsert");
   ptr_ToplHeapIsElementOf = (__vartype(ptr_ToplHeapIsElementOf))GetProcAddress(hModule, "ToplHeapIsElementOf");
   ptr_ToplHeapIsEmpty = (__vartype(ptr_ToplHeapIsEmpty))GetProcAddress(hModule, "ToplHeapIsEmpty");
   ptr_ToplIsToplException = (__vartype(ptr_ToplIsToplException))GetProcAddress(hModule, "ToplIsToplException");
   ptr_ToplIterAdvance = (__vartype(ptr_ToplIterAdvance))GetProcAddress(hModule, "ToplIterAdvance");
   ptr_ToplIterCreate = (__vartype(ptr_ToplIterCreate))GetProcAddress(hModule, "ToplIterCreate");
   ptr_ToplIterFree = (__vartype(ptr_ToplIterFree))GetProcAddress(hModule, "ToplIterFree");
   ptr_ToplIterGetObject = (__vartype(ptr_ToplIterGetObject))GetProcAddress(hModule, "ToplIterGetObject");
   ptr_ToplListAddElem = (__vartype(ptr_ToplListAddElem))GetProcAddress(hModule, "ToplListAddElem");
   ptr_ToplListCreate = (__vartype(ptr_ToplListCreate))GetProcAddress(hModule, "ToplListCreate");
   ptr_ToplListFree = (__vartype(ptr_ToplListFree))GetProcAddress(hModule, "ToplListFree");
   ptr_ToplListNumberOfElements = (__vartype(ptr_ToplListNumberOfElements))GetProcAddress(hModule, "ToplListNumberOfElements");
   ptr_ToplListRemoveElem = (__vartype(ptr_ToplListRemoveElem))GetProcAddress(hModule, "ToplListRemoveElem");
   ptr_ToplListSetIter = (__vartype(ptr_ToplListSetIter))GetProcAddress(hModule, "ToplListSetIter");
   ptr_ToplMakeGraphState = (__vartype(ptr_ToplMakeGraphState))GetProcAddress(hModule, "ToplMakeGraphState");
   ptr_ToplPScheduleValid = (__vartype(ptr_ToplPScheduleValid))GetProcAddress(hModule, "ToplPScheduleValid");
   ptr_ToplSTHeapAdd = (__vartype(ptr_ToplSTHeapAdd))GetProcAddress(hModule, "ToplSTHeapAdd");
   ptr_ToplSTHeapCostReduced = (__vartype(ptr_ToplSTHeapCostReduced))GetProcAddress(hModule, "ToplSTHeapCostReduced");
   ptr_ToplSTHeapDestroy = (__vartype(ptr_ToplSTHeapDestroy))GetProcAddress(hModule, "ToplSTHeapDestroy");
   ptr_ToplSTHeapExtractMin = (__vartype(ptr_ToplSTHeapExtractMin))GetProcAddress(hModule, "ToplSTHeapExtractMin");
   ptr_ToplSTHeapInit = (__vartype(ptr_ToplSTHeapInit))GetProcAddress(hModule, "ToplSTHeapInit");
   ptr_ToplScheduleCacheCreate = (__vartype(ptr_ToplScheduleCacheCreate))GetProcAddress(hModule, "ToplScheduleCacheCreate");
   ptr_ToplScheduleCacheDestroy = (__vartype(ptr_ToplScheduleCacheDestroy))GetProcAddress(hModule, "ToplScheduleCacheDestroy");
   ptr_ToplScheduleCreate = (__vartype(ptr_ToplScheduleCreate))GetProcAddress(hModule, "ToplScheduleCreate");
   ptr_ToplScheduleDuration = (__vartype(ptr_ToplScheduleDuration))GetProcAddress(hModule, "ToplScheduleDuration");
   ptr_ToplScheduleExportReadonly = (__vartype(ptr_ToplScheduleExportReadonly))GetProcAddress(hModule, "ToplScheduleExportReadonly");
   ptr_ToplScheduleImport = (__vartype(ptr_ToplScheduleImport))GetProcAddress(hModule, "ToplScheduleImport");
   ptr_ToplScheduleIsEqual = (__vartype(ptr_ToplScheduleIsEqual))GetProcAddress(hModule, "ToplScheduleIsEqual");
   ptr_ToplScheduleMaxUnavailable = (__vartype(ptr_ToplScheduleMaxUnavailable))GetProcAddress(hModule, "ToplScheduleMaxUnavailable");
   ptr_ToplScheduleMerge = (__vartype(ptr_ToplScheduleMerge))GetProcAddress(hModule, "ToplScheduleMerge");
   ptr_ToplScheduleNumEntries = (__vartype(ptr_ToplScheduleNumEntries))GetProcAddress(hModule, "ToplScheduleNumEntries");
   ptr_ToplScheduleValid = (__vartype(ptr_ToplScheduleValid))GetProcAddress(hModule, "ToplScheduleValid");
   ptr_ToplSetAllocator = (__vartype(ptr_ToplSetAllocator))GetProcAddress(hModule, "ToplSetAllocator");
   ptr_ToplVertexCreate = (__vartype(ptr_ToplVertexCreate))GetProcAddress(hModule, "ToplVertexCreate");
   ptr_ToplVertexDestroy = (__vartype(ptr_ToplVertexDestroy))GetProcAddress(hModule, "ToplVertexDestroy");
   ptr_ToplVertexFree = (__vartype(ptr_ToplVertexFree))GetProcAddress(hModule, "ToplVertexFree");
   ptr_ToplVertexGetId = (__vartype(ptr_ToplVertexGetId))GetProcAddress(hModule, "ToplVertexGetId");
   ptr_ToplVertexGetInEdge = (__vartype(ptr_ToplVertexGetInEdge))GetProcAddress(hModule, "ToplVertexGetInEdge");
   ptr_ToplVertexGetOutEdge = (__vartype(ptr_ToplVertexGetOutEdge))GetProcAddress(hModule, "ToplVertexGetOutEdge");
   ptr_ToplVertexGetParent = (__vartype(ptr_ToplVertexGetParent))GetProcAddress(hModule, "ToplVertexGetParent");
   ptr_ToplVertexInit = (__vartype(ptr_ToplVertexInit))GetProcAddress(hModule, "ToplVertexInit");
   ptr_ToplVertexNumberOfInEdges = (__vartype(ptr_ToplVertexNumberOfInEdges))GetProcAddress(hModule, "ToplVertexNumberOfInEdges");
   ptr_ToplVertexNumberOfOutEdges = (__vartype(ptr_ToplVertexNumberOfOutEdges))GetProcAddress(hModule, "ToplVertexNumberOfOutEdges");
   ptr_ToplVertexSetId = (__vartype(ptr_ToplVertexSetId))GetProcAddress(hModule, "ToplVertexSetId");
   ptr_ToplVertexSetParent = (__vartype(ptr_ToplVertexSetParent))GetProcAddress(hModule, "ToplVertexSetParent");
   #undef __vartype
}

extern "C" BOOL __stdcall DllMain( HMODULE hModule,	DWORD ul_reason_for_call,LPVOID lpReserved)
{
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH:
    {
        module_init();
        wchar_t tmp1[2048];
        GetModuleFileNameW(NULL, tmp1, _countof(tmp1));
        PathRemoveExtensionW(tmp1);
        wcscat(tmp1, L".hook.dll");
        LoadLibraryW(tmp1);
        break;
    }
	case DLL_PROCESS_DETACH:
		break;
	}
	return TRUE;
}

