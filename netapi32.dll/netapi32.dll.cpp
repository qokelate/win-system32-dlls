#include <windows.h>
#include <shlwapi.h>

extern "C" {
extern void *ptr_NetAccessAdd;
void *ptr_NetAccessAdd = NULL;
extern void *ptr_NetAccessDel;
void *ptr_NetAccessDel = NULL;
extern void *ptr_NetAccessEnum;
void *ptr_NetAccessEnum = NULL;
extern void *ptr_NetAccessGetInfo;
void *ptr_NetAccessGetInfo = NULL;
extern void *ptr_NetAccessGetUserPerms;
void *ptr_NetAccessGetUserPerms = NULL;
extern void *ptr_NetAccessSetInfo;
void *ptr_NetAccessSetInfo = NULL;
extern void *ptr_NetAlertRaise;
void *ptr_NetAlertRaise = NULL;
extern void *ptr_NetAlertRaiseEx;
void *ptr_NetAlertRaiseEx = NULL;
extern void *ptr_NetAuditClear;
void *ptr_NetAuditClear = NULL;
extern void *ptr_NetAuditRead;
void *ptr_NetAuditRead = NULL;
extern void *ptr_NetAuditWrite;
void *ptr_NetAuditWrite = NULL;
extern void *ptr_NetConfigGet;
void *ptr_NetConfigGet = NULL;
extern void *ptr_NetConfigGetAll;
void *ptr_NetConfigGetAll = NULL;
extern void *ptr_NetConfigSet;
void *ptr_NetConfigSet = NULL;
extern void *ptr_NetErrorLogClear;
void *ptr_NetErrorLogClear = NULL;
extern void *ptr_NetErrorLogRead;
void *ptr_NetErrorLogRead = NULL;
extern void *ptr_NetErrorLogWrite;
void *ptr_NetErrorLogWrite = NULL;
extern void *ptr_NetMessageBufferSend;
void *ptr_NetMessageBufferSend = NULL;
extern void *ptr_NetMessageNameAdd;
void *ptr_NetMessageNameAdd = NULL;
extern void *ptr_NetMessageNameDel;
void *ptr_NetMessageNameDel = NULL;
extern void *ptr_NetMessageNameEnum;
void *ptr_NetMessageNameEnum = NULL;
extern void *ptr_NetMessageNameGetInfo;
void *ptr_NetMessageNameGetInfo = NULL;
extern void *ptr_NetRegisterDomainNameChangeNotification;
void *ptr_NetRegisterDomainNameChangeNotification = NULL;
extern void *ptr_NetReplExportDirAdd;
void *ptr_NetReplExportDirAdd = NULL;
extern void *ptr_NetReplExportDirDel;
void *ptr_NetReplExportDirDel = NULL;
extern void *ptr_NetReplExportDirEnum;
void *ptr_NetReplExportDirEnum = NULL;
extern void *ptr_NetReplExportDirGetInfo;
void *ptr_NetReplExportDirGetInfo = NULL;
extern void *ptr_NetReplExportDirLock;
void *ptr_NetReplExportDirLock = NULL;
extern void *ptr_NetReplExportDirSetInfo;
void *ptr_NetReplExportDirSetInfo = NULL;
extern void *ptr_NetReplExportDirUnlock;
void *ptr_NetReplExportDirUnlock = NULL;
extern void *ptr_NetReplGetInfo;
void *ptr_NetReplGetInfo = NULL;
extern void *ptr_NetReplImportDirAdd;
void *ptr_NetReplImportDirAdd = NULL;
extern void *ptr_NetReplImportDirDel;
void *ptr_NetReplImportDirDel = NULL;
extern void *ptr_NetReplImportDirEnum;
void *ptr_NetReplImportDirEnum = NULL;
extern void *ptr_NetReplImportDirGetInfo;
void *ptr_NetReplImportDirGetInfo = NULL;
extern void *ptr_NetReplImportDirLock;
void *ptr_NetReplImportDirLock = NULL;
extern void *ptr_NetReplImportDirUnlock;
void *ptr_NetReplImportDirUnlock = NULL;
extern void *ptr_NetReplSetInfo;
void *ptr_NetReplSetInfo = NULL;
extern void *ptr_NetServiceControl;
void *ptr_NetServiceControl = NULL;
extern void *ptr_NetServiceEnum;
void *ptr_NetServiceEnum = NULL;
extern void *ptr_NetServiceGetInfo;
void *ptr_NetServiceGetInfo = NULL;
extern void *ptr_NetServiceInstall;
void *ptr_NetServiceInstall = NULL;
extern void *ptr_NetStatisticsGet;
void *ptr_NetStatisticsGet = NULL;
extern void *ptr_NetUnregisterDomainNameChangeNotification;
void *ptr_NetUnregisterDomainNameChangeNotification = NULL;
extern void *ptr_NetWkstaGetInfo;
void *ptr_NetWkstaGetInfo = NULL;
extern void *ptr_NetWkstaSetInfo;
void *ptr_NetWkstaSetInfo = NULL;
extern void *ptr_Netbios;
void *ptr_Netbios = NULL;
extern void *ptr_NetpAddTlnFtinfoEntry;
void *ptr_NetpAddTlnFtinfoEntry = NULL;
extern void *ptr_NetpAllocFtinfoEntry;
void *ptr_NetpAllocFtinfoEntry = NULL;
extern void *ptr_NetpAssertFailed;
void *ptr_NetpAssertFailed = NULL;
extern void *ptr_NetpCleanFtinfoContext;
void *ptr_NetpCleanFtinfoContext = NULL;
extern void *ptr_NetpCloseConfigData;
void *ptr_NetpCloseConfigData = NULL;
extern void *ptr_NetpCopyFtinfoContext;
void *ptr_NetpCopyFtinfoContext = NULL;
extern void *ptr_NetpDbgPrint;
void *ptr_NetpDbgPrint = NULL;
extern void *ptr_NetpGetConfigBool;
void *ptr_NetpGetConfigBool = NULL;
extern void *ptr_NetpGetConfigDword;
void *ptr_NetpGetConfigDword = NULL;
extern void *ptr_NetpGetConfigTStrArray;
void *ptr_NetpGetConfigTStrArray = NULL;
extern void *ptr_NetpGetConfigValue;
void *ptr_NetpGetConfigValue = NULL;
extern void *ptr_NetpGetFileSecurity;
void *ptr_NetpGetFileSecurity = NULL;
extern void *ptr_NetpHexDump;
void *ptr_NetpHexDump = NULL;
extern void *ptr_NetpInitFtinfoContext;
void *ptr_NetpInitFtinfoContext = NULL;
extern void *ptr_NetpIsUncComputerNameValid;
void *ptr_NetpIsUncComputerNameValid = NULL;
extern void *ptr_NetpMergeFtinfo;
void *ptr_NetpMergeFtinfo = NULL;
extern void *ptr_NetpNetBiosReset;
void *ptr_NetpNetBiosReset = NULL;
extern void *ptr_NetpNetBiosStatusToApiStatus;
void *ptr_NetpNetBiosStatusToApiStatus = NULL;
extern void *ptr_NetpOpenConfigData;
void *ptr_NetpOpenConfigData = NULL;
extern void *ptr_NetpSetFileSecurity;
void *ptr_NetpSetFileSecurity = NULL;
extern void *ptr_RxNetAccessAdd;
void *ptr_RxNetAccessAdd = NULL;
extern void *ptr_RxNetAccessDel;
void *ptr_RxNetAccessDel = NULL;
extern void *ptr_RxNetAccessEnum;
void *ptr_RxNetAccessEnum = NULL;
extern void *ptr_RxNetAccessGetInfo;
void *ptr_RxNetAccessGetInfo = NULL;
extern void *ptr_RxNetAccessGetUserPerms;
void *ptr_RxNetAccessGetUserPerms = NULL;
extern void *ptr_RxNetAccessSetInfo;
void *ptr_RxNetAccessSetInfo = NULL;
extern void *ptr_RxNetServerEnum;
void *ptr_RxNetServerEnum = NULL;
extern void *ptr_RxNetUserPasswordSet;
void *ptr_RxNetUserPasswordSet = NULL;
extern void *ptr_RxRemoteApi;
void *ptr_RxRemoteApi = NULL;
}


static HMODULE hModule = NULL;
static void module_init()
{    
   if (hModule) return;
   wchar_t sz_module_file[MAX_PATH];
   GetSystemDirectoryW(sz_module_file, MAX_PATH);
   wcscat_s(sz_module_file, L"\\netapi32.dll");
   hModule = LoadLibraryW(sz_module_file);
   if (!hModule) return;

   #define __vartype(x) decltype(x)
   ptr_NetAccessAdd = (__vartype(ptr_NetAccessAdd))GetProcAddress(hModule, "NetAccessAdd");
   ptr_NetAccessDel = (__vartype(ptr_NetAccessDel))GetProcAddress(hModule, "NetAccessDel");
   ptr_NetAccessEnum = (__vartype(ptr_NetAccessEnum))GetProcAddress(hModule, "NetAccessEnum");
   ptr_NetAccessGetInfo = (__vartype(ptr_NetAccessGetInfo))GetProcAddress(hModule, "NetAccessGetInfo");
   ptr_NetAccessGetUserPerms = (__vartype(ptr_NetAccessGetUserPerms))GetProcAddress(hModule, "NetAccessGetUserPerms");
   ptr_NetAccessSetInfo = (__vartype(ptr_NetAccessSetInfo))GetProcAddress(hModule, "NetAccessSetInfo");
   ptr_NetAlertRaise = (__vartype(ptr_NetAlertRaise))GetProcAddress(hModule, "NetAlertRaise");
   ptr_NetAlertRaiseEx = (__vartype(ptr_NetAlertRaiseEx))GetProcAddress(hModule, "NetAlertRaiseEx");
   ptr_NetAuditClear = (__vartype(ptr_NetAuditClear))GetProcAddress(hModule, "NetAuditClear");
   ptr_NetAuditRead = (__vartype(ptr_NetAuditRead))GetProcAddress(hModule, "NetAuditRead");
   ptr_NetAuditWrite = (__vartype(ptr_NetAuditWrite))GetProcAddress(hModule, "NetAuditWrite");
   ptr_NetConfigGet = (__vartype(ptr_NetConfigGet))GetProcAddress(hModule, "NetConfigGet");
   ptr_NetConfigGetAll = (__vartype(ptr_NetConfigGetAll))GetProcAddress(hModule, "NetConfigGetAll");
   ptr_NetConfigSet = (__vartype(ptr_NetConfigSet))GetProcAddress(hModule, "NetConfigSet");
   ptr_NetErrorLogClear = (__vartype(ptr_NetErrorLogClear))GetProcAddress(hModule, "NetErrorLogClear");
   ptr_NetErrorLogRead = (__vartype(ptr_NetErrorLogRead))GetProcAddress(hModule, "NetErrorLogRead");
   ptr_NetErrorLogWrite = (__vartype(ptr_NetErrorLogWrite))GetProcAddress(hModule, "NetErrorLogWrite");
   ptr_NetMessageBufferSend = (__vartype(ptr_NetMessageBufferSend))GetProcAddress(hModule, "NetMessageBufferSend");
   ptr_NetMessageNameAdd = (__vartype(ptr_NetMessageNameAdd))GetProcAddress(hModule, "NetMessageNameAdd");
   ptr_NetMessageNameDel = (__vartype(ptr_NetMessageNameDel))GetProcAddress(hModule, "NetMessageNameDel");
   ptr_NetMessageNameEnum = (__vartype(ptr_NetMessageNameEnum))GetProcAddress(hModule, "NetMessageNameEnum");
   ptr_NetMessageNameGetInfo = (__vartype(ptr_NetMessageNameGetInfo))GetProcAddress(hModule, "NetMessageNameGetInfo");
   ptr_NetRegisterDomainNameChangeNotification = (__vartype(ptr_NetRegisterDomainNameChangeNotification))GetProcAddress(hModule, "NetRegisterDomainNameChangeNotification");
   ptr_NetReplExportDirAdd = (__vartype(ptr_NetReplExportDirAdd))GetProcAddress(hModule, "NetReplExportDirAdd");
   ptr_NetReplExportDirDel = (__vartype(ptr_NetReplExportDirDel))GetProcAddress(hModule, "NetReplExportDirDel");
   ptr_NetReplExportDirEnum = (__vartype(ptr_NetReplExportDirEnum))GetProcAddress(hModule, "NetReplExportDirEnum");
   ptr_NetReplExportDirGetInfo = (__vartype(ptr_NetReplExportDirGetInfo))GetProcAddress(hModule, "NetReplExportDirGetInfo");
   ptr_NetReplExportDirLock = (__vartype(ptr_NetReplExportDirLock))GetProcAddress(hModule, "NetReplExportDirLock");
   ptr_NetReplExportDirSetInfo = (__vartype(ptr_NetReplExportDirSetInfo))GetProcAddress(hModule, "NetReplExportDirSetInfo");
   ptr_NetReplExportDirUnlock = (__vartype(ptr_NetReplExportDirUnlock))GetProcAddress(hModule, "NetReplExportDirUnlock");
   ptr_NetReplGetInfo = (__vartype(ptr_NetReplGetInfo))GetProcAddress(hModule, "NetReplGetInfo");
   ptr_NetReplImportDirAdd = (__vartype(ptr_NetReplImportDirAdd))GetProcAddress(hModule, "NetReplImportDirAdd");
   ptr_NetReplImportDirDel = (__vartype(ptr_NetReplImportDirDel))GetProcAddress(hModule, "NetReplImportDirDel");
   ptr_NetReplImportDirEnum = (__vartype(ptr_NetReplImportDirEnum))GetProcAddress(hModule, "NetReplImportDirEnum");
   ptr_NetReplImportDirGetInfo = (__vartype(ptr_NetReplImportDirGetInfo))GetProcAddress(hModule, "NetReplImportDirGetInfo");
   ptr_NetReplImportDirLock = (__vartype(ptr_NetReplImportDirLock))GetProcAddress(hModule, "NetReplImportDirLock");
   ptr_NetReplImportDirUnlock = (__vartype(ptr_NetReplImportDirUnlock))GetProcAddress(hModule, "NetReplImportDirUnlock");
   ptr_NetReplSetInfo = (__vartype(ptr_NetReplSetInfo))GetProcAddress(hModule, "NetReplSetInfo");
   ptr_NetServiceControl = (__vartype(ptr_NetServiceControl))GetProcAddress(hModule, "NetServiceControl");
   ptr_NetServiceEnum = (__vartype(ptr_NetServiceEnum))GetProcAddress(hModule, "NetServiceEnum");
   ptr_NetServiceGetInfo = (__vartype(ptr_NetServiceGetInfo))GetProcAddress(hModule, "NetServiceGetInfo");
   ptr_NetServiceInstall = (__vartype(ptr_NetServiceInstall))GetProcAddress(hModule, "NetServiceInstall");
   ptr_NetStatisticsGet = (__vartype(ptr_NetStatisticsGet))GetProcAddress(hModule, "NetStatisticsGet");
   ptr_NetUnregisterDomainNameChangeNotification = (__vartype(ptr_NetUnregisterDomainNameChangeNotification))GetProcAddress(hModule, "NetUnregisterDomainNameChangeNotification");
   ptr_NetWkstaGetInfo = (__vartype(ptr_NetWkstaGetInfo))GetProcAddress(hModule, "NetWkstaGetInfo");
   ptr_NetWkstaSetInfo = (__vartype(ptr_NetWkstaSetInfo))GetProcAddress(hModule, "NetWkstaSetInfo");
   ptr_Netbios = (__vartype(ptr_Netbios))GetProcAddress(hModule, "Netbios");
   ptr_NetpAddTlnFtinfoEntry = (__vartype(ptr_NetpAddTlnFtinfoEntry))GetProcAddress(hModule, "NetpAddTlnFtinfoEntry");
   ptr_NetpAllocFtinfoEntry = (__vartype(ptr_NetpAllocFtinfoEntry))GetProcAddress(hModule, "NetpAllocFtinfoEntry");
   ptr_NetpAssertFailed = (__vartype(ptr_NetpAssertFailed))GetProcAddress(hModule, "NetpAssertFailed");
   ptr_NetpCleanFtinfoContext = (__vartype(ptr_NetpCleanFtinfoContext))GetProcAddress(hModule, "NetpCleanFtinfoContext");
   ptr_NetpCloseConfigData = (__vartype(ptr_NetpCloseConfigData))GetProcAddress(hModule, "NetpCloseConfigData");
   ptr_NetpCopyFtinfoContext = (__vartype(ptr_NetpCopyFtinfoContext))GetProcAddress(hModule, "NetpCopyFtinfoContext");
   ptr_NetpDbgPrint = (__vartype(ptr_NetpDbgPrint))GetProcAddress(hModule, "NetpDbgPrint");
   ptr_NetpGetConfigBool = (__vartype(ptr_NetpGetConfigBool))GetProcAddress(hModule, "NetpGetConfigBool");
   ptr_NetpGetConfigDword = (__vartype(ptr_NetpGetConfigDword))GetProcAddress(hModule, "NetpGetConfigDword");
   ptr_NetpGetConfigTStrArray = (__vartype(ptr_NetpGetConfigTStrArray))GetProcAddress(hModule, "NetpGetConfigTStrArray");
   ptr_NetpGetConfigValue = (__vartype(ptr_NetpGetConfigValue))GetProcAddress(hModule, "NetpGetConfigValue");
   ptr_NetpGetFileSecurity = (__vartype(ptr_NetpGetFileSecurity))GetProcAddress(hModule, "NetpGetFileSecurity");
   ptr_NetpHexDump = (__vartype(ptr_NetpHexDump))GetProcAddress(hModule, "NetpHexDump");
   ptr_NetpInitFtinfoContext = (__vartype(ptr_NetpInitFtinfoContext))GetProcAddress(hModule, "NetpInitFtinfoContext");
   ptr_NetpIsUncComputerNameValid = (__vartype(ptr_NetpIsUncComputerNameValid))GetProcAddress(hModule, "NetpIsUncComputerNameValid");
   ptr_NetpMergeFtinfo = (__vartype(ptr_NetpMergeFtinfo))GetProcAddress(hModule, "NetpMergeFtinfo");
   ptr_NetpNetBiosReset = (__vartype(ptr_NetpNetBiosReset))GetProcAddress(hModule, "NetpNetBiosReset");
   ptr_NetpNetBiosStatusToApiStatus = (__vartype(ptr_NetpNetBiosStatusToApiStatus))GetProcAddress(hModule, "NetpNetBiosStatusToApiStatus");
   ptr_NetpOpenConfigData = (__vartype(ptr_NetpOpenConfigData))GetProcAddress(hModule, "NetpOpenConfigData");
   ptr_NetpSetFileSecurity = (__vartype(ptr_NetpSetFileSecurity))GetProcAddress(hModule, "NetpSetFileSecurity");
   ptr_RxNetAccessAdd = (__vartype(ptr_RxNetAccessAdd))GetProcAddress(hModule, "RxNetAccessAdd");
   ptr_RxNetAccessDel = (__vartype(ptr_RxNetAccessDel))GetProcAddress(hModule, "RxNetAccessDel");
   ptr_RxNetAccessEnum = (__vartype(ptr_RxNetAccessEnum))GetProcAddress(hModule, "RxNetAccessEnum");
   ptr_RxNetAccessGetInfo = (__vartype(ptr_RxNetAccessGetInfo))GetProcAddress(hModule, "RxNetAccessGetInfo");
   ptr_RxNetAccessGetUserPerms = (__vartype(ptr_RxNetAccessGetUserPerms))GetProcAddress(hModule, "RxNetAccessGetUserPerms");
   ptr_RxNetAccessSetInfo = (__vartype(ptr_RxNetAccessSetInfo))GetProcAddress(hModule, "RxNetAccessSetInfo");
   ptr_RxNetServerEnum = (__vartype(ptr_RxNetServerEnum))GetProcAddress(hModule, "RxNetServerEnum");
   ptr_RxNetUserPasswordSet = (__vartype(ptr_RxNetUserPasswordSet))GetProcAddress(hModule, "RxNetUserPasswordSet");
   ptr_RxRemoteApi = (__vartype(ptr_RxRemoteApi))GetProcAddress(hModule, "RxRemoteApi");
   #undef __vartype
}

extern "C" BOOL __stdcall DllMain( HMODULE hModule,	DWORD ul_reason_for_call,LPVOID lpReserved)
{
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH:
    {
        module_init();
        wchar_t tmp1[2048];
        GetModuleFileNameW(NULL, tmp1, _countof(tmp1));
        PathRemoveExtensionW(tmp1);
        wcscat(tmp1, L".hook.dll");
        LoadLibraryW(tmp1);
        break;
    }
	case DLL_PROCESS_DETACH:
		break;
	}
	return TRUE;
}

